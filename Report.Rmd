---
title: "Dark Market"
author: "Simon Delecourt & Edouard Donze"
output:
  html_notebook:
    code_folding: hide
    highlight: pygments
    number_sections: yes
    theme: readable
    toc: yes
  pdf_document:
    highlight: pygments
    number_sections: yes
    toc: yes
mainfont: Arial
---

```{r Library}
#----------------------------------------------------------
#                       Library :
#----------------------------------------------------------

#install.packages("stringr")
#install.packages("units")
#install.packages("ggmap")

library(stringr)
library(units)
library(ggmap)
```

```{r Importation}
#----------------------------------------------------------
#               Importation of the data :
#----------------------------------------------------------

data <- as.data.frame(read.csv("C:/BDP/Doc/alphaspider.csv"))
```


```{r Cleaning}
#----------------------------------------------------------
#                Cleaning Function :
#----------------------------------------------------------

CleaningData <- function(database) {
  for(i in 2:4)
    { database[,i] <- iconv(database[,i], from="UTF-8", to="latin9", sub=" ")   
          # conversion UTF in ISO/IEC 8859-15  
      database[,i] <- gsub(pattern="<.*?>|\n", replacement=" ", database[,i])   
          # HTML tags and \n
      database[,i] <- tolower(database[,i])                                     
          # put in lowercase
      database[,i] <- gsub(pattern="\\s{2,}", replacement=" ", database[,i])    
          # remove spaces
    }
  
  return (database)
  
}

data <- CleaningData(database = data)

```

```{r Computer Readable}
#----------------------------------------------------------
#      Making data readable in a computering way : 
#----------------------------------------------------------

ComputerReadable <- function(database) {

  oz_conversion <- 28.3495
      
  #-----------------------------
  #  Handling : Dose and unit
  #-----------------------------
  
    # 1- Extraction of characters matching with the dose and unit in the title
  
  # Vector with all the unit that are allowed (add unit if needed)
  unit_allowed <- c("mg","kg", "ug","lb","oz","ounce","g\\s","gr","gram") 
  
  # Construct a regular expression matching with digits + units allowed
  regex_unit <- str_c("([0-9]+\\.?[0-9]*)((?:(\\s|)((",unit_allowed[1],")")
  
  for(i in 2:length(unit_allowed)){
    regex_unit <- str_c(regex_unit,"|(",unit_allowed[i],")")
  }
  
  regex_unit <- str_c(regex_unit,")))")
  # regex_unit = regular expression for dose and unit
  
  # Extraction from the title :
  dose_unit <- str_extract(database$title, regex_unit)
  
    # 2- Spliting the value and the unit
  
  # Construct a regular expression 
  regex_extrac_unit <- str_c("(.*?)(",unit_allowed[1])
  
  for(i in 1:length(unit_allowed)){
    regex_extrac_unit <- str_c(regex_extrac_unit,"|",unit_allowed[i])
  }
  
  regex_extrac_unit <- str_c(regex_extrac_unit,")")
  
  # Spliting thanks to the regular expresion (regex_extrac_unit)
  dose_unit <- str_match(dose_unit, regex_extrac_unit)
  
  # amelioration of the string (removing blank)
  dose_unit <- trimws(dose_unit)
  
    # 3- Conversion of units in SI (in order to use a library)
  
  # Vector of conversion : first element of the vector is unit in SI, other elements are non standard unit 
  # Add your vector if needed
  g <- c("g","gr","gram")
  oz <- c("oz","ounce")
  
  for(i in 2 : length(g)){
    dose_unit[,3] <- gsub(pattern=g[i], replacement=g[1],dose_unit[,3])
  }
  
  for(i in 2 : length(oz)){
    dose_unit[,3] <- gsub(pattern=oz[i], replacement=oz[1],dose_unit[,3])
  }
  #add loop for your vector if needed
  
    # 4- Insertion in the data frame
  
  database$dose <- as.numeric(dose_unit[,2])    # Numerical conversion
  database$unit <- dose_unit[,3]
  
      # 5- Conversion to SI units : 1g and 1l
      
  for(i in 1:length(database$unit)) {
      if(!(is.na(database[i,"unit"]))) {
        if ((str_detect(database[i,"unit"],"g") | (str_detect(database[i,"unit"],"lb")))) {
          value <- set_units(database[i,"dose"],with(ud_units,database[i,"unit"]))
          database[i,"dose"] <- as.units(value, with(ud_units, g))
          database[i,"unit"] <- "g"
        }
        else if (str_detect(database[i,"unit"],"l"))  {
          value <- set_units(database[i,"dose"],with(ud_units,database[i,"unit"]))
          database[i,"dose"] <- as.units(value, with(ud_units, l))
          database[i,"unit"] <- "l"
        }
        else if (str_detect(database[i,"unit"],"oz")) {
          database[i,"dose"] <- database[i,"dose"] * oz_conversion
          database[i,"unit"] <- "g"
        }
      }
  } 
  
  #------------------------
  #  Handling : Quantity
  #------------------------
  
    # 1- Extraction of characters matching with the quantity in the title
  
  # (ex : 20 packs, 20x, x20, 20 tabs)
  # add key words here if needed
  key_words_quantity <- c("x","pack", "tab", "pill", "pcs", "piece")
  
  # Particular treatment for "x" because it can be 20x or x20"
  regex_extract_quantity <- str_c("(",key_words_quantity[1],"(\\s|)(\\d+,?\\d+)|(\\d+,?\\d+)(?:([-\\s]|)(",key_words_quantity[1])
  
  for(i in 2 : length(key_words_quantity)){
    regex_extract_quantity <- str_c(regex_extract_quantity,"|",key_words_quantity[i])
  }
  
  regex_extract_quantity <- str_c(regex_extract_quantity,")))")
  
  # Extraction from the title + insertion in the data frame :
  database$quantity  <- str_extract(database$title,regex_extract_quantity)
  
  # Keeping only digits
  database$quantity  <- str_extract(database$quantity , "(\\d+,?\\d+)")
  
    # 2- Conversion in numerical element
  
  # English numbers to Standard numbers (problem with the comma)
  database$quantity <- gsub(pattern=",", replacement="", database$quantity) 
  
  # Conversion :
  database$quantity <- as.numeric(database$quantity)
  
  
  #-----------------------
  #   Handling : Price
  #-----------------------
  
    # 1- column price as numeric :
      
  # Keeping only digits (without "USD")
  database$price <- str_extract(database$price, "(\\d+,?\\.?\\d+)")
  
  # English numbers to Standard numbers (problem with the comma)
  database$price <- gsub(pattern=",", replacement="", database$price)
  
  # Conversion :
  database$price <- as.numeric(database$price)
  
    # 2- Price per unit :
  
  # Creation of a new vector with the price per unit
  price_per_unit <- c()
  
  for(i in 1:length(database$quantity)) {
    if(is.na(database[i,"quantity"])) {price_per_unit[i] <- database[i,"price"]}
    else {price_per_unit[i] <- database[i,"price"]/database[i,"quantity"]}
  }
  
  #Insertion in the data frame
  database$priceUnit <- price_per_unit
    
    # 3- Price per unit per dose :
    
  # Creation of a new vector with the price per unit per dose
  price_unit_dose <- c()
  
  for(i in 1:length(database$dose)) {
      if(is.na(database[i,"dose"])) {price_unit_dose[i] <- database[i,"priceUnit"]}
      else {price_unit_dose[i] <- database[i,"priceUnit"]/database[i,"dose"]}
  }
  
  #Insertion in the data frame
  database$priceUnitDose <- price_unit_dose
    
  
  return(database) 
} 

data <- ComputerReadable(database = data)

```

# - Statistics

We have perform basics statics in order to discover the database. 

1. First of all, here is a general view of ads distribution in the world.

```{r Number of ads}
#-----------------------------------------------
#      Number of ads in the world
#-----------------------------------------------

NumberOfAds <- function(database) {

  #Get rid of unwanted orign like Worldwide and Null which are not relevant
  matching_vector <- c(  !str_detect(database$origin, "Worldwide") & !str_detect(database$origin, "NULL"))
  
  sumup <- sort(summary(database[matching_vector, "origin"]), decreasing=TRUE)
  
  #Bar plot with the total number ofs ads in each country
  barp <- barplot(sumup[1:10], main="Number of ads in the World", xlab="Countries", ylab="Number of ads",ylim = c(0,4000),  col = rainbow(10), cex.names = 0.8)
  
  barp <- text(x = barp, y = sumup[1:10], label = sumup[1:10], pos=3 , cex = 0.8, col= "black")
}
  
NumberOfAds(database = data)


```
The bar-chart represents the 10 main dealers in the world regarding the number of ads. As we can see, US is the biggest dealer far ahead of other. Their number of ads is more than twice as big as the number of the second (UK). Moreover, most of these countries are developed countries, that is to say US and European countries. We can also notice that China and Afghanistan are presents.  

2. Now let's see the distribution of ads per category.

```{r Function Select Drugs}
  selectDrug <- function(drugName, database){
    matching_vector <- c( (str_detect(database$category, drugName)))
    return(matching_vector)
  }
```



```{r Distribution of Drugs}
#-----------------------------------------------
#      Distribution of Drugs in the market
#-----------------------------------------------

DistributionDrugs <- function(database) {

  #----------------------------
  #   The most common drugs
  #----------------------------
  
  drugs <- c("Cocaine", "Meth", "LSD", "Opioids", "Cannabis", "Steroids", "Ecstasy", "Ketamine", "Heroin", "Shrooms", "Tobacco", "Benzos", "Paraphernalia")
  
  freq <- c()
  for(i in 1:length(drugs)){
    matching_vector <- selectDrug(drugName =  drugs[i], database = data);
    sumup<-summary(matching_vector)
    freq[i] <- sumup[3]
  }
  
  freq <- as.numeric(freq)
  
  res <- data.frame(drugs, freq)
  res <- res[order(res$freq, decreasing = TRUE),]
  
  #----------------------
  #     Pie Chart 
  #----------------------
  
  # 1- Labels :
  
  # Calculation in percentage
  piepercent<- round(100*res$freq/sum(res$freq), 1)
    # round(a,1) : one digit after the comma
  
  lab <- c()
  
  for(i in 1:length(piepercent)) {
    lab[i] <- paste(piepercent[[i]], "%", sep=" ")
  }
  
  # 2- Title :
  title <- "Distribution of drugs"
  
  # 3- Colors :
  c <- rainbow(length(piepercent))
  
  # 4- Plot :
  pie(piepercent,labels = lab, main = title ,col=c)
  
  # 5- Legend :
  legend(1.3,0.8,res$drugs, cex = 0.7, fill = c)
}

DistributionDrugs(database = data)

```

At first sight, drugs and chemicals are principle products dealt in the black market. They represents more than 50% of the global market. It is also interesting to see that the second product that is sold is counterfeit and paper fraud. On top of that, we can notice that a small percentage concern Jewel, Gold and Weapon.  


3. Let's focus on Drugs Market now.

```{r}
#---------------------------------------------------
#           Number of ads of Drugs in the world
#--------------------------------------------------

#Get rid of unwanted orign like Worldwide and Null which are not relevant
matching_vector <- c( str_detect(data$category, "Drugs") & !str_detect(data$origin, "Worldwide") & !str_detect(data$origin, "NULL"))

sumup <- sort(summary(data[matching_vector, "origin"]), decreasing=TRUE)
par(mfrow = c(1,1))
#Bar plot with the total number of ads of Drugs in each country

barp <- barplot(sumup[1:10], main="Number of ads of Drugs in the World", xlab="Countries", ylab="Number of ads",ylim = c(0,3200),  col = rainbow(10), cex.names = 0.8, angle = 45)
barp <- text(x = barp, y = sumup[1:10], label = sumup[1:10], pos=3 , cex = 0.8, col= "black")

```


At first sight, the chart is similar to the first one. This is coherent, indeed by comparing the ratio between drugs ads and the total number of ads, we can deduced that there are mainly dealing drugs. This also match with the second chart that show us that drugs are the main product in the market. There are few exceptions such as Afghanistan which has been replaced by India and Canada has been reversed with China. Finally, let's note that drugs market is gathered in Europe and United States.


4. Take a global view of the drugs market in Europe with the following map.

```{r Europe Map}

MapEurope <- function(database) {

  #Select the ads about drugs and get rid of the irrelevant orign Worlwide
  matching_vector <- c( (str_detect(database$category, "Drugs") ) & !str_detect(database$origin, "Worldwide"))
  
  sumup <- sort(summary(database[matching_vector, "origin"]), decreasing=TRUE)
  
  #read a file containing the latitude and longitude of the "center" of each country
  data_country <- read.csv("C:/BDP/UEL-project/Stats/lat_long.csv")
  lat_long <- data.frame(Country = data_country$Country , long=  data_country$Longitude..average., lat=  data_country$Latitude..average.)
  
  #Create a data.frame with the name of the country and its nb of ads
  v <- data.frame(name= names(sumup) , amount = sumup)
  
  #Merge v with lat_long in order to have a data with Country/NbofAds/lattitude/longitude
  data_plot <- merge(v, lat_long,  by.x = "name", by.y = "Country" )
  
  #Create a map of EUROPE with circles showing the amount of ads
  map <- get_map(location = 'Europe', zoom =4 )
  mapPoints <- ggmap(map)  + xlab("") + ylab("") + ggtitle("Number of ads of Drugs in the World")+
    geom_point(data = data_plot,aes(x =long, y = lat, size =amount)) +scale_size_continuous(limits=c(0,3000),breaks=c(0,500,1000,1500,2000), range = c(2,20)) 
  
  #Display
  mapPoints
}

MapEurope(database = data)

```

Circles shows the amount of ads about drugs. The map confirm our assumptions that there are a lot of Drug dealers in Europe with, as major dealers countries, United Kingdom, Netherlands and Germany.   



```{r Import / Export}
#-----------------------------------------------
#   Importation / Exportation of a country
#-----------------------------------------------

country_Import_Export <- function(country,num) {

  #-------------------
  #  Initialization
  #-------------------

  # Importation / Exportation :
  if (num == 0) { 
    way <- "origin"
    txt <- "- Exportation"
  } else if (num == 1) {
    way <- "destination"
    txt <- "- Importation"
  }
  
  #------------------
  #    Analysis
  #------------------
  
  # Country as destination
  matching_vector <- str_detect(data[,way], country)
  
  # list of the categories (among the line that have "Country" as origin)
  # -> Products (categories) exporting by the country 
  country_cat <- data[matching_vector,"category"] 
  
  # Handling of this categories
  # Regular expression for spliting the categories
  regex <- "/(.*)/(.*)/(.*)"
  cat <- str_match(country_cat, regex)
  
  # Counting this categories 
  tab <- table(cat[,3])   #cat[,3] : 2nd category 
  tab <- sort(tab, decreasing = TRUE)  # Sorting (biggest in first) 
  tab <- tab[1:10] # Taking only the most important
  
  
  #-----------------
  #    Pie Chart     
  #-----------------
  
  # 1- Labels :
  
  # Calculation in percentage
  piepercent<- round(100*tab/sum(tab), 1)
     # round(a,1) : one digit after the comma
  
  lab <- c()
  
  for(i in 1:length(piepercent)) {
    lab[i] <- paste(piepercent[[i]], "%", sep=" ")
  }
  
  # 2- Title :
  title <- paste(country, txt, sep=" ")
  
  # 3- Colors :
  c <- rainbow(length(piepercent))
 
  # 4- Margin : 
  #par(mar=c(3,3,3,0))
  
  # 5- Plot :
  pie(piepercent,labels = lab, main = title ,col=c)
  
  # 6- Legend :
  legend(1.2,0.9, names(piepercent), cex = 0.7, fill = c)
  
}

```

```{r}
country_Import_Export("United Kingdom",0)
```




```{r}
country_Import_Export("China",0)
```


```{r}
country_Import_Export("France",0)
```

```{r}
country_Import_Export("France",1)
```




```{r Drugs Prices}

DrugsPrices <- function(database) {
  
  drugs <- c("Cocaine", "Meth", "Opioids", "Cannabis", "Steroids", "Ecstasy", "Ketamine", "Heroin",  "NBOME","Shrooms", "Tobacco", "Benzos", "Paraphernalia")
  
  med <-c()
  for(i in 1:length(drugs)){
    matching_vector <- selectDrug(drugName =  drugs[i], database = data);
    med[i] <- median((database[matching_vector, "priceUnitDose"]))
  }
  priceDrugs <- data.frame(drugs, med); 
  
  priceDrugs$med <- round(priceDrugs$med,2)
  
  priceDrugs <- priceDrugs[order(priceDrugs$med, decreasing=TRUE), ]
  
  barp <- barplot(priceDrugs$med, main="Average Price of Drugs in the World", names.arg = priceDrugs$drugs, ylim = c(0,500),  xlab="Drugs", ylab="Price in USD", cex.names = 0.8, col =rainbow(length(priceDrugs$drugs)) )
  barp <- text(x = barp, y = priceDrugs$med, label = paste(priceDrugs$med, " $", sep=""), pos=3 , cex = 0.8, col= "Black")

}

DrugsPrices(database = data)
```


